<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>streat</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: sans-serif;
  }
  h1 {
    font-size: 1rem;
    opacity: 0.6;
    text-align: center;
  }
</style>
</head>
<body>

<h1>sound is playing...</h1>

<script>
// ======== 設定 =========
const FILE = "streat.wav";   // 音源ファイル
const FADE = 4;              // クロスフェード秒数
// =======================

// Web Audio API
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let buffer = null;

// 2つのプレイヤー（A/B）
let current = null;
let next = null;

// 音源ロード
async function loadSound() {
  const res = await fetch(FILE);
  const arr = await res.arrayBuffer();
  buffer = await audioCtx.decodeAudioData(arr);
}

// プレイヤー生成
function createPlayer(gainStart) {
  const source = audioCtx.createBufferSource();
  const gain = audioCtx.createGain();
  source.buffer = buffer;
  gain.gain.value = gainStart;
  source.connect(gain).connect(audioCtx.destination);
  return { source, gain };
}

function startLoop() {
  const duration = buffer.duration;

  // A と B の初期化
  current = createPlayer(1); // 先に鳴る
  next = createPlayer(0);    // 後から入る

  const t0 = audioCtx.currentTime;

  current.source.start(t0);

  scheduleNext(t0, duration);
}

function scheduleNext(startTime, duration) {
  const fadeStart = startTime + duration - FADE;

  // 次のプレイヤー start
  next.source.start(fadeStart);

  // フェードイン
  next.gain.setValueAtTime(0, fadeStart);
  next.gain.linearRampToValueAtTime(1, fadeStart + FADE);

  // フェードアウト
  current.gain.setValueAtTime(1, fadeStart);
  current.gain.linearRampToValueAtTime(0, fadeStart + FADE);

  // 次ループ予約
  const newStart = startTime + duration;

  setTimeout(() => {
    const old = current;
    current = next;
    next = createPlayer(0);
    scheduleNext(newStart, duration);
  }, (duration - FADE) * 1000);
}

// iPhone 対応（タップ開始）
document.body.addEventListener("click", async () => {
  await audioCtx.resume();
  if (!buffer) {
    await loadSound();
    startLoop();
  }
}, { once: true });

</script>

</body>
</html>
